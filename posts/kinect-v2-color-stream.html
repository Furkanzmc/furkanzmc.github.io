<!doctype html>
<html lang="en">

<head>
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>zmc.space | C++: Color Stream with Kinect v2</title>
  <meta name="description" content="Get the color data from Kinect v2">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="C++: Color Stream with Kinect v2">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://zmc.space/posts/kinect-v2-color-stream">
  <meta property="og:description" content="Get the color data from Kinect v2">
  <meta property="og:site_name" content="zmc.space">
  <meta property="og:image" content="http://zmc.space/assets/og-image.jpg">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="http://zmc.space/posts/kinect-v2-color-stream">
  <meta name="twitter:title" content="C++: Color Stream with Kinect v2">
  <meta name="twitter:description" content="Get the color data from Kinect v2">
  <meta name="twitter:image" content="http://zmc.space/assets/og-image.jpg">

  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link href="http://zmc.space/feed.xml" type="application/rss+xml" rel="alternate" title="zmc.space Last 10 blog posts" />

  

  
    <link rel="stylesheet" href="/assets/light.css">

  
</head>

<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav appear">
  <a href="/" class="header-logo" title="zmc.space">zmc.space</a>
  <ul class="header-links">
    
    
      <li>
        <a href="https://twitter.com/Furkanzmc" rel="noreferrer noopener" target="_blank" title="Twitter">
          <span class="icon icon-twitter"></span>
        </a>
      </li>
    
    
    
      <li>
        <a href="https://github.com/Furkanzmc" rel="noreferrer noopener" target="_blank" title="GitHub">
          <span class="icon icon-github"></span>
        </a>
      </li>
    
    
    
    
    
    
    
  </ul>
</nav>

        <article class="article appear">
          <header class="article-header">
            <h1>C++: Color Stream with Kinect v2</h1>
            <p>Get the color data from Kinect v2</p>
            <div class="article-list-footer">
              <span class="article-list-date">
                February 8, 2016
              </span>
              <span class="article-list-divider">-</span>
              <span class="article-list-minutes">
                
                
                  5 minute read
                
              </span>
              <span class="article-list-divider">-</span>
              <div class="article-list-tags">
                
                  <a href="/tag/cpp">cpp</a>
                
                  <a href="/tag/kinect">kinect</a>
                
                  <a href="/tag/programming">programming</a>
                
              </div>
            </div>
          </header>

          <div class="article-content">
            <p>Kinect v2 supports 1080p RGB image and has 30 frames per second. So you can get much better quality than Kinect v1 which supported 640x480.</p>

<p>Let’s talk about the interfaces we need for getting the color stream from the sensor.</p>

<ul>
  <li><code class="highlighter-rouge">RGBQUAD</code> is a structure that stores red, green and blue data fro an image.</li>
  <li><code class="highlighter-rouge">IColorFrameReader</code> is the interface we use to read color frames from the sensor.</li>
  <li><code class="highlighter-rouge">IColorFrameSource</code> is the interface that opens up a bridge for us to open a color frame reader.</li>
  <li><code class="highlighter-rouge">IColorFrame</code> represents a frame from the frame reader.</li>
  <li><code class="highlighter-rouge">IFrameDescription</code> stores the properties of an image frame from the sensor, like height, width, field of view etc…</li>
</ul>

<p>The flow for getting the color data is similar to getting body data. We first have to connect to our sensor, get the color source from the sensor and using the color source open a color frame reader. Then we can use that reader to get our color frame. Then using that frame we get our raw RGBQUAD data. We can use casting to convert RGBQUAD to any RGB representation your graphics library needs. For example, with openFrameworks you can convert RGBQUAD to unsigned char and load that data to a texture. Let’s see how this works out in code. I’m going to be using openFrameworks for this tutorial.</p>

<p>Let’s see our member variables.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="nl">private:</span>
    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">m_ColorWidth</span><span class="p">,</span> <span class="n">m_ColorHeight</span><span class="p">;</span>
    <span class="n">IKinectSensor</span> <span class="o">*</span><span class="n">m_KinectSensor</span><span class="p">;</span>
    <span class="n">IColorFrameReader</span> <span class="o">*</span><span class="n">m_ColorFrameReader</span><span class="p">;</span>
    <span class="n">RGBQUAD</span> <span class="o">*</span><span class="n">m_ColorRGBX</span><span class="p">;</span><span class="c1">//Stores raw RGB data
</span>    <span class="n">ofTexture</span> <span class="n">m_Texture</span><span class="p">;</span>

<span class="c1">//Constructor in ofApp.cpp
</span>
<span class="n">ofApp</span><span class="o">::</span><span class="n">ofApp</span><span class="p">()</span>
    <span class="o">:</span> <span class="n">m_ColorWidth</span><span class="p">(</span><span class="mi">1920</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">m_ColorHeight</span><span class="p">(</span><span class="mi">1080</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">m_KinectSensor</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">m_ColorFrameReader</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">m_ColorRGBX</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">m_Texture</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//Here we create heap storage for color pixel data
</span>    <span class="n">m_ColorRGBX</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RGBQUAD</span><span class="p">[</span><span class="n">m_ColorWidth</span> <span class="o">*</span> <span class="n">m_ColorHeight</span><span class="p">];</span>
<span class="p">}</span></code></pre></figure>

<p>Now, let’s setup the sensor for color stream.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">HRESULT</span> <span class="n">hr</span> <span class="o">=</span> <span class="n">GetDefaultKinectSensor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_KinectSensor</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">m_KinectSensor</span> <span class="o">&amp;&amp;</span> <span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// Initialize the Kinect and get the color reader
</span>    <span class="n">IColorFrameSource</span> <span class="o">*</span><span class="n">colorFrameSource</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>

    <span class="n">hr</span> <span class="o">=</span> <span class="n">m_KinectSensor</span><span class="o">-&gt;</span><span class="n">Open</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">hr</span> <span class="o">=</span> <span class="n">m_KinectSensor</span><span class="o">-&gt;</span><span class="n">get_ColorFrameSource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">colorFrameSource</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">hr</span> <span class="o">=</span> <span class="n">colorFrameSource</span><span class="o">-&gt;</span><span class="n">OpenReader</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_ColorFrameReader</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">safeRelease</span><span class="p">(</span><span class="n">colorFrameSource</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_KinectSensor</span> <span class="o">||</span> <span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">": No ready Kinect is found!</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>From now on, we’re going to use <code class="highlighter-rouge">m_ColorFrameReader</code> to access color data. We need to access it every frame to get updated color data. So we’re going to get the new frames in our <code class="highlighter-rouge">ofApp::update</code> method.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">ofApp</span><span class="o">::</span><span class="n">update</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m_ColorFrameReader</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">IColorFrame</span> <span class="o">*</span><span class="n">colorFrame</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
    <span class="n">HRESULT</span> <span class="n">hr</span> <span class="o">=</span> <span class="n">m_ColorFrameReader</span><span class="o">-&gt;</span><span class="n">AcquireLatestFrame</span><span class="p">(</span><span class="o">&amp;</span><span class="n">colorFrame</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">IFrameDescription</span> <span class="o">*</span><span class="n">frameDescription</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">UINT</span> <span class="n">bufferSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">RGBQUAD</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">hr</span> <span class="o">=</span> <span class="n">colorFrame</span><span class="o">-&gt;</span><span class="n">get_FrameDescription</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frameDescription</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">hr</span> <span class="o">=</span> <span class="n">frameDescription</span><span class="o">-&gt;</span><span class="n">get_Width</span><span class="p">(</span><span class="o">&amp;</span><span class="n">width</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">hr</span> <span class="o">=</span> <span class="n">frameDescription</span><span class="o">-&gt;</span><span class="n">get_Height</span><span class="p">(</span><span class="o">&amp;</span><span class="n">height</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">m_ColorRGBX</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">m_ColorRGBX</span><span class="p">;</span>
            <span class="n">bufferSize</span> <span class="o">=</span> <span class="n">m_ColorWidth</span> <span class="o">*</span> <span class="n">m_ColorHeight</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">RGBQUAD</span><span class="p">);</span>
            <span class="n">hr</span> <span class="o">=</span> <span class="n">colorFrame</span><span class="o">-&gt;</span><span class="n">CopyConvertedFrameDataToArray</span><span class="p">(</span><span class="n">bufferSize</span><span class="p">,</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">BYTE</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">ColorImageFormat_Rgba</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">hr</span> <span class="o">=</span> <span class="n">E_FAIL</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">//If the width/height given from the sensor is the same as the default resolution, it means we get a valid data
</span>        <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">width</span> <span class="o">==</span> <span class="n">m_ColorWidth</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">height</span> <span class="o">==</span> <span class="n">m_ColorHeight</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// Draw the data with Direct2D
</span>            <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">m_Texture</span><span class="p">.</span><span class="n">loadData</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">m_ColorWidth</span><span class="p">,</span> <span class="n">m_ColorHeight</span><span class="p">,</span> <span class="n">GL_RGBA</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">safeRelease</span><span class="p">(</span><span class="n">frameDescription</span><span class="p">);</span>
    <span class="n">safeRelease</span><span class="p">(</span><span class="n">colorFrame</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>Lastly we draw the image in our <code class="highlighter-rouge">ofApp::draw</code> method.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">ofApp</span><span class="o">::</span><span class="n">draw</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m_Texture</span><span class="p">.</span><span class="n">isAllocated</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">m_Texture</span><span class="p">.</span><span class="n">draw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Keep in mind that color frames come in 30 FPS. If you are developing a game or an interactive application with higher FPS needs you’ll have the get the data from another thread to prevent FPS loss. We’ll look into how you can do that after we finish with the streams.</p>

<p>Previous Posts</p>

<ul>
  <li><a href="http://zmc.space/2016/kinect-v2-introduction/">Introduction to Kinect v2</a></li>
  <li><a href="http://zmc.space/2016/kinect-v2-body-tracking/">Body Tracking with Kinect v2</a></li>
</ul>


          </div>

          <div class="article-share">
            
            
            <a href="https://twitter.com/home?status=C%2B%2B%3A+Color+Stream+with+Kinect+v2 - http://zmc.space/posts/kinect-v2-color-stream by @Furkanzmc" title="Share on Twitter" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M492 109.5c-17.4 7.7-36 12.9-55.6 15.3 20-12 35.4-31 42.6-53.6 -18.7 11.1-39.4 19.2-61.5 23.5C399.8 75.8 374.6 64 346.8 64c-53.5 0-96.8 43.4-96.8 96.9 0 7.6 0.8 15 2.5 22.1 -80.5-4-151.9-42.6-199.6-101.3 -8.3 14.3-13.1 31-13.1 48.7 0 33.6 17.2 63.3 43.2 80.7C67 210.7 52 206.3 39 199c0 0.4 0 0.8 0 1.2 0 47 33.4 86.1 77.7 95 -8.1 2.2-16.7 3.4-25.5 3.4 -6.2 0-12.3-0.6-18.2-1.8 12.3 38.5 48.1 66.5 90.5 67.3 -33.1 26-74.9 41.5-120.3 41.5 -7.8 0-15.5-0.5-23.1-1.4C62.8 432 113.7 448 168.3 448 346.6 448 444 300.3 444 172.2c0-4.2-0.1-8.4-0.3-12.5C462.6 146 479 129 492 109.5z"/></svg>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://zmc.space/posts/kinect-v2-color-stream" title="Share on Facebook" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M288 192v-38.1c0-17.2 3.8-25.9 30.5-25.9H352V64h-55.9c-68.5 0-91.1 31.4-91.1 85.3V192h-45v64h45v192h83V256h56.4l7.6-64H288z"/></svg>
            </a>
            <a href="https://plus.google.com/share?url=http://zmc.space/posts/kinect-v2-color-stream" title="Share on Google+" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 128 128"><path d="M40.7 55.9v16.1c0 0 15.6 0 22 0C59.2 82.5 53.8 88.2 40.7 88.2c-13.3 0-23.7-10.8-23.7-24.2s10.4-24.2 23.7-24.2c7.1 0 11.6 2.5 15.8 5.9 3.3-3.3 3.1-3.8 11.6-11.9 -7.2-6.6-16.8-10.6-27.4-10.6C18.2 23.3 0 41.5 0 64c0 22.5 18.2 40.7 40.7 40.7 33.6 0 41.8-29.3 39-48.8H40.7zM113.9 56.7V42.6h-10.1v14.1H89.4v10.1h14.5v14.5h10.1V66.8H128V56.7H113.9z"/></svg>
            </a>
          </div>

          
            <div id="disqus_thread" class="article-comments"></div>
            <script src="https://zmcspace.disqus.com/embed.js" async defer></script>
            <noscript>Please enable JavaScript to view the comments.</noscript>
          
        </article>
        <footer class="footer appear">
  <p>
    <a href="/about" title="About me">Furkan Üzümcü</a>
  </p>
</footer>

      </div>
    </div>
  </main>
  
  <script>
    window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
    ga('create','UA-71841354-1','auto');ga('send','pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async></script>


<script src="/assets/vendor.js"></script>



  <script src="/assets/webfonts.js"></script>




  <script src="/assets/scrollappear.js"></script>



<script src="/assets/application.js"></script>


</body>
</html>
