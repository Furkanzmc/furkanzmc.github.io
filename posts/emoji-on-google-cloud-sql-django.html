<!doctype html>
<html lang="en">

<head>
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>zmc.space | How to Support Emoji on Google Cloud SQL and Django</title>
  <meta name="description" content="Support Emojis in Your MySQL Database">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="How to Support Emoji on Google Cloud SQL and Django">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://zmc.space/posts/emoji-on-google-cloud-sql-django">
  <meta property="og:description" content="Support Emojis in Your MySQL Database">
  <meta property="og:site_name" content="zmc.space">
  <meta property="og:image" content="http://zmc.space/assets/og-image.jpg">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="http://zmc.space/posts/emoji-on-google-cloud-sql-django">
  <meta name="twitter:title" content="How to Support Emoji on Google Cloud SQL and Django">
  <meta name="twitter:description" content="Support Emojis in Your MySQL Database">
  <meta name="twitter:image" content="http://zmc.space/assets/og-image.jpg">

  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link href="http://zmc.space/feed.xml" type="application/rss+xml" rel="alternate" title="zmc.space Last 10 blog posts" />

  

  
    <link rel="stylesheet" href="/assets/light.css">

  
</head>

<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav appear">
  <a href="/" class="header-logo" title="zmc.space">zmc.space</a>
  <ul class="header-links">
    
    
      <li>
        <a href="https://twitter.com/Furkanzmc" rel="noreferrer noopener" target="_blank" title="Twitter">
          <span class="icon icon-twitter"></span>
        </a>
      </li>
    
    
    
      <li>
        <a href="https://github.com/Furkanzmc" rel="noreferrer noopener" target="_blank" title="GitHub">
          <span class="icon icon-github"></span>
        </a>
      </li>
    
    
    
    
    
    
    
  </ul>
</nav>

        <article class="article appear">
          <header class="article-header">
            <h1>How to Support Emoji on Google Cloud SQL and Django</h1>
            <p>Support Emojis in Your MySQL Database</p>
            <div class="article-list-footer">
              <span class="article-list-date">
                September 14, 2017
              </span>
              <span class="article-list-divider">-</span>
              <span class="article-list-minutes">
                
                
                  2 minute read
                
              </span>
              <span class="article-list-divider">-</span>
              <div class="article-list-tags">
                
                  <a href="/tag/django">django</a>
                
                  <a href="/tag/python">python</a>
                
                  <a href="/tag/google_cloud">google_cloud</a>
                
              </div>
            </div>
          </header>

          <div class="article-content">
            <p>To enable emojis in your database, you just need to create it using <code class="highlighter-rouge">utf8mb4</code> charset and <code class="highlighter-rouge">utf8mb4_bin</code> collation. And then you can insert emojis to your database. But it’s not that straightforward when you are using Django and Google Cloud SQL.</p>

<p>You can read why it’s no straightforward <a href="https://github.com/GoogleCloudPlatform/appengine-django-skeleton/issues/28">here</a>. There’s also a StackOverflow question <a href="https://stackoverflow.com/questions/36144026/unable-to-use-utf8mb4-character-set-with-cloudsql-on-appengine-python">here</a>.</p>

<blockquote>
  <p>The issue is in the C code that we use to talk to MySQL. It doesn’t support utf8mb4 itself, so when it makes a connection to MySQL, it tells the server to use “UTF8”, which in MySQL means UTF-8 minus the 4-byte characters… and all your emojis get mangled.</p>
</blockquote>

<p>And the workaround is</p>

<blockquote>
  <p>Edit your base.py and change get_new_connection so that it sends the “SET NAMES utf8mb4” command.</p>
</blockquote>

<p>It’s actually pretty simple to solve. Just change your <code class="highlighter-rouge">django/db/backends/mysql/base.py</code> and edit <code class="highlighter-rouge">get_new_connection</code> method so it looks like the following:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_new_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn_params</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">conn_params</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">encoders</span><span class="p">[</span><span class="n">SafeText</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">encoders</span><span class="p">[</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">]</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">encoders</span><span class="p">[</span><span class="n">SafeBytes</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">encoders</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s">"SET NAMES utf8mb4"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conn</span></code></pre></figure>

<p>But this change will only apply to your local environment, and to your virtual environment if you are using one. So, you need to have a copy of the changes when you are deploying to Google App Engine. And Google App Engine requires that you vendor your external libraries. So you when do that you copy will be overwritten by the new one.</p>

<p>The way I deploy my projects is by using a script that takes the gt branch, downloads the required libraries and then deploy it based on the given parameters. So I do not keep a copy of the libraries in my repository. I simply download them once when I’m deploying. So, to solve the overwriting issue I copied only the <code class="highlighter-rouge">django/db/backends/mysql</code> folder to my project folder and then changed the database engine to point to my local copy.</p>

<p>So it looks like the following</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'default'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'myproject.mysql'</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>


          </div>

          <div class="article-share">
            
            
            <a href="https://twitter.com/home?status=How+to+Support+Emoji+on+Google+Cloud+SQL+and+Django - http://zmc.space/posts/emoji-on-google-cloud-sql-django by @Furkanzmc" title="Share on Twitter" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M492 109.5c-17.4 7.7-36 12.9-55.6 15.3 20-12 35.4-31 42.6-53.6 -18.7 11.1-39.4 19.2-61.5 23.5C399.8 75.8 374.6 64 346.8 64c-53.5 0-96.8 43.4-96.8 96.9 0 7.6 0.8 15 2.5 22.1 -80.5-4-151.9-42.6-199.6-101.3 -8.3 14.3-13.1 31-13.1 48.7 0 33.6 17.2 63.3 43.2 80.7C67 210.7 52 206.3 39 199c0 0.4 0 0.8 0 1.2 0 47 33.4 86.1 77.7 95 -8.1 2.2-16.7 3.4-25.5 3.4 -6.2 0-12.3-0.6-18.2-1.8 12.3 38.5 48.1 66.5 90.5 67.3 -33.1 26-74.9 41.5-120.3 41.5 -7.8 0-15.5-0.5-23.1-1.4C62.8 432 113.7 448 168.3 448 346.6 448 444 300.3 444 172.2c0-4.2-0.1-8.4-0.3-12.5C462.6 146 479 129 492 109.5z"/></svg>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://zmc.space/posts/emoji-on-google-cloud-sql-django" title="Share on Facebook" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M288 192v-38.1c0-17.2 3.8-25.9 30.5-25.9H352V64h-55.9c-68.5 0-91.1 31.4-91.1 85.3V192h-45v64h45v192h83V256h56.4l7.6-64H288z"/></svg>
            </a>
            <a href="https://plus.google.com/share?url=http://zmc.space/posts/emoji-on-google-cloud-sql-django" title="Share on Google+" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 128 128"><path d="M40.7 55.9v16.1c0 0 15.6 0 22 0C59.2 82.5 53.8 88.2 40.7 88.2c-13.3 0-23.7-10.8-23.7-24.2s10.4-24.2 23.7-24.2c7.1 0 11.6 2.5 15.8 5.9 3.3-3.3 3.1-3.8 11.6-11.9 -7.2-6.6-16.8-10.6-27.4-10.6C18.2 23.3 0 41.5 0 64c0 22.5 18.2 40.7 40.7 40.7 33.6 0 41.8-29.3 39-48.8H40.7zM113.9 56.7V42.6h-10.1v14.1H89.4v10.1h14.5v14.5h10.1V66.8H128V56.7H113.9z"/></svg>
            </a>
          </div>

          
            <div id="disqus_thread" class="article-comments"></div>
            <script src="https://zmcspace.disqus.com/embed.js" async defer></script>
            <noscript>Please enable JavaScript to view the comments.</noscript>
          
        </article>
        <footer class="footer appear">
  <p>
    <a href="/about" title="About me">Furkan Üzümcü</a>
  </p>
</footer>

      </div>
    </div>
  </main>
  
  <script>
    window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
    ga('create','UA-71841354-1','auto');ga('send','pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async></script>


<script src="/assets/vendor.js"></script>



  <script src="/assets/webfonts.js"></script>




  <script src="/assets/scrollappear.js"></script>



<script src="/assets/application.js"></script>


</body>
</html>
